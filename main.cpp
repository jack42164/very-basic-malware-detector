#include <cstdio>
#include <iostream>
#include <experimental/filesystem>
#include <cstdlib>
#include <ctime>
#include <string>
#include <fstream>
#include <istream>
#include <unistd.h>


using namespace std;

void delete_temp() {
    
    
    const char* file = "temp.text";
    remove(file);
}




void delete_final(){

    
}
/*
    gets the total kBytes of storage remaining in the filesystem



*/
int get_kBytes() {

    string lastLine;
    string actualLine;
    system("df --output=used --total >> temp.text");
    ifstream check;
    
    check.open("temp.text");

    getline(check, lastLine);
    
    while (!(check.eof())) { check >> lastLine; }
    
    delete_temp();
    
    return stoi(lastLine);
}

int check_storage() {
    
    double total_storage = 0;
    int kBytes;
    int current_storage;
    int second_storage;
    int delta_storage;
    
    // for n times, test this for a couple seconds
    for (int i = 0; i < 5; i++) { // tests for 2.5 seconds, can increase
    
        // cout << "hi" << endl;
        kBytes = get_kBytes();
        
        // cout << kBytes << endl;

        current_storage = kBytes; // stores num of kBytes to current storage

        // wait ~500 msg
        usleep(500000); // in nanoseconds
        
        kBytes = get_kBytes();
        second_storage = get_kBytes(); // do df and get the size or something

        delta_storage = second_storage - current_storage;
        
        
        
        total_storage += delta_storage;
    }
    
    cout << "kB change: " << total_storage << endl;
    return total_storage;
}

int main() {

    // argc must == 1, where 1 is the malware file

    // argv[0] is a.out
    
    // check_storage();
    // get_kBytes();
    
    int storage_change;
    int threshhold = 100;
    
    // launch malware job
    // ideally the user would input the sample malware.exe file but it didn't work out oof
    system("./hack.exe &");
    
    // continue with program
    storage_change = check_storage();
    
    if (storage_change > threshhold) {
           
        system("pkill " + malware + "&");
        remove(malware);
        cout << "abnormal file" << endl;
    }

    return 0;
}



